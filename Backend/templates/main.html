<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì±—ë´‡ ì„œë¹„ìŠ¤ - ë©”ì¸</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding-top: 20px; background-color: #f0f2f5; }
        .header { display: flex; justify-content: space-between; align-items: center; width: 90%; max-width: 1000px; padding: 10px 0; border-bottom: 2px solid #ccc; margin-bottom: 30px; }
        .user-info { font-size: 1.1em; }
        .user-id { font-weight: bold; color: #007bff; margin-left: 5px; }
        .company-name { font-weight: bold; color: #5cb85c; margin-right: 5px; }
        .logout-button { padding: 8px 15px; background-color: #f44336; color: white; border: none; cursor: pointer; border-radius: 4px; }
        .login-button { padding: 8px 15px; background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 4px; }
        .container { text-align: center; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .product-list { display: flex; flex-direction: column; gap: 15px; }
        .product-button { border: 1px solid #007bff; background-color: #fff; color: #007bff; padding: 12px 25px; border-radius: 25px; font-size: 16px; cursor: pointer; transition: background-color 0.2s, color 0.2s; width: 300px; }
        .product-button:hover { background-color: #007bff; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <h1>AI ì œí’ˆ ì„¤ëª… ì±—ë´‡</h1>
        <div class="user-info">
            <span id="greeting-message"></span>
        </div>
    </div>
    
    <div class="container">
        <h2 id="user-greeting">ì¸ì¦ ì •ë³´ í™•ì¸ ì¤‘...</h2> 
        <p>ë¬¸ì˜í•  ì œí’ˆì„ ì„ íƒí•˜ì„¸ìš”.</p>
        <div class="product-list">
            <button class="product-button" onclick="goToChat('SDH-E18KPA')">SDH-E18KPA</button>
            <button class="product-button" onclick="goToChat('SIF-14SSWT')">SIF-14SSWT</button>
            <button class="product-button" onclick="goToChat('SDH-E45KPA')">SDH-E45KPA</button>
        </div>
    </div>

    <script>
        const LOGIN_PAGE_URL = '/login'; 
        const token = localStorage.getItem('access_token');
        const greetingElement = document.getElementById('user-greeting');
        const messageElement = document.getElementById('greeting-message');
        const userInfoDiv = document.querySelector('.user-info');

        function logout() {
            localStorage.removeItem('access_token');
            alert("ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.");
            window.location.href = LOGIN_PAGE_URL;
        }

        function goToChat(pid) {
            // í† í°ì´ ì—†ìœ¼ë©´ ì±„íŒ…ì„ ë§‰ê³  ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ìœ ë„
            if (!token) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ì±„íŒ…ì„ ì´ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                window.location.href = LOGIN_PAGE_URL;
                return;
            }
            window.location.href = `/chat/${pid}`;
        }

        // ğŸŒŸğŸŒŸ ì„œë²„ APIë¥¼ í†µí•´ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•µì‹¬ ë¡œì§ ğŸŒŸğŸŒŸ
        const fetchUserInfo = async () => {
            if (!token) {
                // 1. ë¹„íšŒì› ë¡œì§ (í† í°ì´ ì—†ì„ ê²½ìš°)
                messageElement.innerHTML = 'ë¹„íšŒì› ìƒíƒœì…ë‹ˆë‹¤.';
                greetingElement.innerText = 'ë¡œê·¸ì¸í•˜ê³  ë” ë§ì€ ê¸°ëŠ¥ì„ ì´ìš©í•´ë³´ì„¸ìš”.';
                
                const loginButton = document.createElement('button');
                loginButton.className = 'login-button';
                loginButton.innerText = 'ë¡œê·¸ì¸';
                loginButton.onclick = () => { window.location.href = LOGIN_PAGE_URL; };
                userInfoDiv.appendChild(loginButton);
                return;
            }
            
            // 2. íšŒì› ë¡œì§ (í† í°ì´ ìˆì„ ê²½ìš° ì„œë²„ì— ê²€ì¦ ìš”ì²­)
            try {
                const response = await fetch('http://localhost:8000/api/user/me', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}` // âœ… í† í° ì „ì†¡
                    },
                    body: JSON.stringify({})
                });

                const userInfo = await response.json();
                console.log(userInfo)
                if (response.ok) {
                    console.log("í™•ì¸ì™„ë£Œ")
                    const userId = userInfo.id;
                    const companyName = userInfo.company_name;
                    const name = userInfo.name;

                    messageElement.innerHTML = `
                        <span class="company-name">${companyName}</span> ì†Œì†
                        <span class="user-id">${name}</span> ë‹˜
                    `;
                    greetingElement.innerText = `í™˜ì˜í•©ë‹ˆë‹¤, ${name}ë‹˜!`;
                    
                    // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ë™ì  ìƒì„±
                    const logoutButton = document.createElement('button');
                    logoutButton.className = 'logout-button';
                    logoutButton.innerText = 'ë¡œê·¸ì•„ì›ƒ';
                    logoutButton.onclick = logout;
                    userInfoDiv.appendChild(logoutButton);

                } else if (response.status === 401) {
                    // 4. ì„œë²„ê°€ 401 (í† í° ë§Œë£Œ/ìœ íš¨í•˜ì§€ ì•ŠìŒ)ì„ ë°˜í™˜í•œ ê²½ìš° ì²˜ë¦¬
                    const detail = userInfo.detail || "ì¸ì¦ ì‹¤íŒ¨";
                    alert(`ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${detail}`);
                    logout();
                } else {
                    throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                }

            } catch (error) {
                console.error("ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:", error);
                // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì—°ê²° ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
                greetingElement.innerText = 'ì¸ì¦ ì„œë²„ ì—°ê²° ì‹¤íŒ¨';
                alert("ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì¤‘ ì¹˜ëª…ì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                localStorage.removeItem('access_token'); // ì•ˆì „ì„ ìœ„í•´ í† í° ì‚­ì œ
            }
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        fetchUserInfo();
    </script>
</body>
</html>