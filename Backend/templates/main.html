<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 챗봇 서비스 - 메인</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding-top: 20px; background-color: #f0f2f5; }
        .header { display: flex; justify-content: space-between; align-items: center; width: 90%; max-width: 1000px; padding: 10px 0; border-bottom: 2px solid #ccc; margin-bottom: 30px; }
        .user-info { font-size: 1.1em; }
        .user-id { font-weight: bold; color: #007bff; margin-left: 5px; }
        .company-name { font-weight: bold; color: #5cb85c; margin-right: 5px; }
        .logout-button { padding: 8px 15px; background-color: #f44336; color: white; border: none; cursor: pointer; border-radius: 4px; }
        .login-button { padding: 8px 15px; background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 4px; }
        .container { text-align: center; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .product-list { display: flex; flex-direction: column; gap: 15px; }
        .product-button { border: 1px solid #007bff; background-color: #fff; color: #007bff; padding: 12px 25px; border-radius: 25px; font-size: 16px; cursor: pointer; transition: background-color 0.2s, color 0.2s; width: 300px; }
        .product-button:hover { background-color: #007bff; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <h1>AI 제품 설명 챗봇</h1>
        <div class="user-info">
            <span id="greeting-message"></span>
        </div>
    </div>
    
    <div class="container">
        <h2 id="user-greeting">인증 정보 확인 중...</h2> 
        <p>문의할 제품을 선택하세요.</p>
        <div class="product-list">
            <button class="product-button" onclick="goToChat('SDH-E18KPA')">SDH-E18KPA</button>
            <button class="product-button" onclick="goToChat('SIF-14SSWT')">SIF-14SSWT</button>
            <button class="product-button" onclick="goToChat('SDH-E45KPA')">SDH-E45KPA</button>
        </div>
    </div>

    <script>
        const LOGIN_PAGE_URL = '/login'; 
        const token = localStorage.getItem('access_token');
        const greetingElement = document.getElementById('user-greeting');
        const messageElement = document.getElementById('greeting-message');
        const userInfoDiv = document.querySelector('.user-info');

        function logout() {
            localStorage.removeItem('access_token');
            alert("로그아웃되었습니다.");
            window.location.href = LOGIN_PAGE_URL;
        }

        function goToChat(pid) {
            // 토큰이 없으면 채팅을 막고 로그인 페이지로 유도
            if (!token) {
                alert("로그인이 필요합니다. 채팅을 이용하려면 로그인해주세요.");
                window.location.href = LOGIN_PAGE_URL;
                return;
            }
            window.location.href = `/chat/${pid}`;
        }

        // 🌟🌟 서버 API를 통해 사용자 정보를 가져오는 핵심 로직 🌟🌟
        const fetchUserInfo = async () => {
            if (!token) {
                // 1. 비회원 로직 (토큰이 없을 경우)
                messageElement.innerHTML = '비회원 상태입니다.';
                greetingElement.innerText = '로그인하고 더 많은 기능을 이용해보세요.';
                
                const loginButton = document.createElement('button');
                loginButton.className = 'login-button';
                loginButton.innerText = '로그인';
                loginButton.onclick = () => { window.location.href = LOGIN_PAGE_URL; };
                userInfoDiv.appendChild(loginButton);
                return;
            }
            
            // 2. 회원 로직 (토큰이 있을 경우 서버에 검증 요청)
            try {
                const response = await fetch('http://localhost:8000/api/user/me', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}` // ✅ 토큰 전송
                    },
                    body: JSON.stringify({})
                });

                const userInfo = await response.json();
                console.log(userInfo)
                if (response.ok) {
                    console.log("확인완료")
                    const userId = userInfo.id;
                    const companyName = userInfo.company_name;
                    const name = userInfo.name;

                    messageElement.innerHTML = `
                        <span class="company-name">${companyName}</span> 소속
                        <span class="user-id">${name}</span> 님
                    `;
                    greetingElement.innerText = `환영합니다, ${name}님!`;
                    
                    // 로그아웃 버튼 동적 생성
                    const logoutButton = document.createElement('button');
                    logoutButton.className = 'logout-button';
                    logoutButton.innerText = '로그아웃';
                    logoutButton.onclick = logout;
                    userInfoDiv.appendChild(logoutButton);

                } else if (response.status === 401) {
                    // 4. 서버가 401 (토큰 만료/유효하지 않음)을 반환한 경우 처리
                    const detail = userInfo.detail || "인증 실패";
                    alert(`세션이 만료되었거나 유효하지 않습니다: ${detail}`);
                    logout();
                } else {
                    throw new Error('서버 응답 오류');
                }

            } catch (error) {
                console.error("사용자 정보 로드 오류:", error);
                // 네트워크 오류 또는 서버 연결 실패 시 처리
                greetingElement.innerText = '인증 서버 연결 실패';
                alert("사용자 정보 로드 중 치명적인 오류가 발생했습니다.");
                localStorage.removeItem('access_token'); // 안전을 위해 토큰 삭제
            }
        };

        // 페이지 로드 시 사용자 정보를 가져옵니다.
        fetchUserInfo();
    </script>
</body>
</html>