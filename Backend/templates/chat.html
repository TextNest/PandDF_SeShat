<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <title>AI Ï±óÎ¥á (PID: {{ pid }})</title>
    <style>
        /* CSS Ïä§ÌÉÄÏùºÏùÄ Î≥ÄÍ≤Ω ÏóÜÏù¥ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö© */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f0f2f5; }
        .chat-container { width: 400px; height: 600px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); background-color: #fff; display: flex; flex-direction: column; }
        .chat-box { flex-grow: 1; padding: 20px; overflow-y: auto; border-bottom: 1px solid #e5e5e5; display: flex; flex-direction: column; }
        .message-bubble { max-width: 75%; padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; line-height: 1.4; word-wrap: break-word; }
        .bot-message { background-color: #e9e9eb; color: #000; align-self: flex-start; }
        .user-message { background-color: #ffeb3b; color: #000; align-self: flex-end; }
        .message-bubble img { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; }
        .input-area { display: flex; padding: 10px; }
        #messageInput { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 15px; font-size: 16px; outline: none; }
        button { border: none; background-color: #007bff; color: white; padding: 10px 20px; border-radius: 20px; margin-left: 10px; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-box" id="chatBox"></div>
        <div class="input-area">
            <input type="text" id="messageInput" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." onkeydown="handleEnter(event)">
            <button onclick="sendMessage()">Ï†ÑÏÜ°</button>
        </div>
    </div>

    <script>
        const pid = "{{ pid }}";
        const chatBox = document.getElementById("chatBox");
        const messageInput = document.getElementById("messageInput");

        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const socket = new WebSocket(`${wsProtocol}//${window.location.host}/ws/${pid}`);


        const addMessageToChat = (sender, content) => {
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message-bubble");
            messageDiv.classList.add(sender === 'bot' ? "bot-message" : "user-message");

            // ÌÖçÏä§Ìä∏ ÎÇ¥Ïö© Ï≤òÎ¶¨
            if (content.text) {
                if (content.isMarkdown) {
                    // ÎßàÌÅ¨Îã§Ïö¥ ÌÖçÏä§Ìä∏Ïùº Í≤ΩÏö∞ HTMLÎ°ú Î≥ÄÌôòÌïòÏó¨ ÏÇΩÏûÖ
                    messageDiv.innerHTML = marked.parse(content.text);
                } else {
                    // ÏùºÎ∞ò ÌÖçÏä§Ìä∏Îäî Í∑∏ÎåÄÎ°ú ÏÇΩÏûÖ
                    messageDiv.textContent = content.text;
                }
            }
            
            // Ïù¥ÎØ∏ÏßÄ ÎÇ¥Ïö© Ï≤òÎ¶¨ (Î∞±ÏóîÎìú ÌÇ§ Ïù¥Î¶Ñ 'image'Î°ú ÌÜµÏùº)
            if (content.image) {
                const imgElement = document.createElement('img');
                imgElement.src = content.image;
                messageDiv.appendChild(imgElement);
            }
            
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        // --- WebSocket Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ ---

        socket.onopen = () => {
            console.log("‚úÖ WebSocket Ïó∞Í≤∞ ÏÑ±Í≥µ");
        };
        
        socket.onmessage = (event) => {
            console.log("üì• ÏÑúÎ≤ÑÎ°úÎ∂ÄÌÑ∞ Î©îÏãúÏßÄ ÏàòÏã†:", event.data);
            const serverData = JSON.parse(event.data);
            
            if (serverData.type === 'bot') {
                // Î∞±ÏóîÎìúÏóêÏÑú Î∞õÏùÄ Î¥á Î©îÏãúÏßÄÎ•º ÌôîÎ©¥Ïóê Ï∂îÍ∞Ä
                // Î∞±ÏóîÎìúÏóêÏÑú Î≥¥ÎÇ∏ ÌÖçÏä§Ìä∏Îäî ÎßàÌÅ¨Îã§Ïö¥ÏúºÎ°ú Í∞ÑÏ£º
                addMessageToChat('bot', { 
                    text: serverData.content, 
                    image: serverData.img, // Î∞±ÏóîÎìú ÌÇ§Îäî 'image'
                    isMarkdown: true 
                });
            }
        };

        socket.onerror = (error) => {
            console.error("‚ùå WebSocket Ïò§Î•ò Î∞úÏÉù:", error);
            addMessageToChat('bot', { text: "ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî." });
        };
        
        socket.onclose = () => {
            console.log("üîå WebSocket Ïó∞Í≤∞ Ï¢ÖÎ£å");
        };

        // --- ÏÇ¨Ïö©Ïûê ÏûÖÎ†• Ï≤òÎ¶¨ Ìï®Ïàò ---

        const sendMessage = () => {
            const messageText = messageInput.value;
            if (messageText.trim() === "") return;

            // ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄÎ•º ÌôîÎ©¥Ïóê Ï¶âÏãú Ï∂îÍ∞Ä (ÎßàÌÅ¨Îã§Ïö¥ ÏïÑÎãò)
            addMessageToChat('user', { text: messageText, isMarkdown: false });
            
            // ÏÑúÎ≤ÑÎ°ú Î©îÏãúÏßÄ Ï†ÑÏÜ°
            socket.send(messageText);
    
            messageInput.value = "";
        };

        const handleEnter = (event) => {
            if (event.key === "Enter") {
                sendMessage();
            }
        };
    </script>
</body>
</html>