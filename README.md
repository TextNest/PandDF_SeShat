# 🐈‍⬛ SeShat - 이미지 식별/추출/분리/저장 프로세스
### 작성자 : ScatterRaven
### Tag : 백엔드 서폿, 이미지 처리, RAG, pdf2image, json,
---
## 🔖 작업 내용
**2025.10.20 ~ 2025.10.24**
|항목|결과|항목|비고|
|-|-|-|-|
|이미지 OCR : PaddleOCR|작업 취소|이미지 내 텍스트 추출|정규화 필요|
|이미지 OCR : PaddleOCR|작업 취소|이미지 내 텍스트 정규화|그룹화를 위해 좌표 정규화 필요|
|이미지 OCR : PaddleOCR|작업 취소|이미지 내 좌표 정규화|완료|
|이미지 처리|완료|pdf 내 페이지 변환|-|
|이미지 처리|완료|메타데이터(페이지) 규격화|변경 가능성 존재|
|이미지 처리|완료|페이지 저장|이미지 병합본 처리 후 진행 재개|
|이미지 처리|완료|병합된 페이지 분할|규격 범위 설정 필요|
|이미지 처리|보류|페이지 내 요소 색인/추출|레이아웃 파싱에 문제 발생 중|
|이미지 처리| |메타데이터(요소) 규격화|변경 가능성 존재|
|이미지 처리| |요소 저장| |
|크래시 대응|완료|규격 외 병합 pdf 처리 실패|최소 규격 제한에 기반, 강제 미분할 적용|
|크래시 대응|완료|특정 pdf 처리 실패|파일명 길이 제한 추가|
|검증 : 모델 이미지 처리| | | |
|검증 : 모델 이미지 기반 설명| | | |
|검증 : 모델 이미지 출력| | | |
---
## 📝 작업 노트
### 🪶 현재 목표 : PDF 내 페이지를 체계적으로 추출/분리/저장하는 모듈 구축

### 1. PDF 페이지 -> 이미지 변환 설계
- poppler(pdf2image) 활용하여 변환
- dpi는 최소 300, 최대 600을 넘지 않도록 규정
- 최적 DPI 추정 : 400

### 2. PDF 이미지 저장 모듈 설계
- 이미지는 png, 메타데이터는 json으로 저장
- 메타데이터 구성은 문서 최하단의 포맷 예시와 동일
- (검토 필요) 챗봇이 출력하는 이미지는 webp로 별도 저장하여 활용

### 3. 변형 : 병합된 이미지 분리 모듈 설계
- 분리 과정 자동화를 위해 처리 로직 설계 필요
- 10개 이상의 변환 이미지 사이즈를 기록해 규격과 허용 가능한 편차 산출, 이후 기준으로 설정
- **일부 PDF의 비정상 규격으로 인한 데이터 소실 문제 관측**, 패딩을 적용하여 규격화
- 탐지 실패 시 육안 확인 후 원인 규정, 수동으로 규격 계산 및 기준 업데이트
- 결과 출력 후 저장 모듈에 반영할 수 있도록 설계 필요

### 4. 에러 : 규격 외 병합 pdf 처리 실패
- 특정 pdf가 A시리즈 규격을 따르지 않음
- 기준에 기반하여 최소 이미지 사이즈에 제한을 두고, 예외 처리를 진행하여 분할 미적용 처리
- 해당 안전장치를 기존 함수에 내장

### 5. 에러 : 특정 pdf 처리 실패
- 특정 pdf를 불러오는데 실패하는 현상 관측
- 확인 결과 : 과도하게 긴 파일명으로 인식 제한에 걸린 것으로 파악
- GPT 확인 결과 : 파일명을 변조하여 짧게 축약된 버전으로 복사한 뒤 처리하는 방법을 제안
- 검토 결과 : 변형된 pdf 생성하는 것은 여러 pdf를 처리해야 하는 상황에서 문제가 될 가능성 다소 존재
- 예외 처리를 적용하여 파일 인식에 실패한 경우 해당 pdf의 처리를 생략하고 경고 출력
- 해당 안전장치를 기존 함수에 내장

### 🪶 추후 목표 : PDF 내 이미지(표, 그래프, 주의문구 블록 등)를 탐지·추출하고, 좌표/섹션 정보를 함께 저장하는 모듈 구축

### 1. PDF 이미지 처리 모듈 설계
- LayoutParser 또는 pdfplumber의 layout 분석 결과를 이용
- LayoutParser의 지속적인 에러 발생, 대응 필요
- 이미지(figure), 표(table), 주의문(warning/caution) 블록을 감지
- 각각의 블록별 페이지, 좌표(x0, y0, x1, y1), 타입, 참조 태그를 JSON 형태로 저장

### 2. 참조 구조 정의
- 텍스트 청크와 마찬가지로 이미지·표도 **“지식 단위”**로서 임베딩될 수 있게 설계해야 함
- (예: "type": "figure", "ref_text": "그림 2-1. 회로 연결도", "coords": [...] 형태)
- 나중에 RAG 단계에서 metadata를 통해 관련 질의 시 해당 표나 그림을 LLM이 인용하거나 표시할 수 있도록 연결하는 것을 고려해야 함

### 3. 시각 참조 기능 구상
- LLM이 “그림 3을 참고하세요.” 같은 응답을 할 때 coords 또는 page_num을 통해 원본 이미지 썸네일을 챗봇이 표시 가능하도록 고려 및 설계
- (예: <img src="page_3_figure_1.png"> 식으로 프론트에서 렌더링)

## 🧾 포맷 예시

### ❓ (미확정) elements.json
```json
[
  {
    "doc_id": "12c1bd20-da56-4e72-8362-29ac2a66bace",
    "page_id": "12c1bd20-da56-4e72-8362-29ac2a66bace_p5",
    "element_id": "12c1bd20-da56-4e72-8362-29ac2a66bace_p5_tb-2-3",
    "origin_page": 5,
    "page": 5,
    "type": "table",
    "bbox": [120, 300, 480, 500],
    "caption": "표 2-3. 주요 스펙 비교",
    "ref_id": "tb-2-3"
  },
  {
    "doc_id": "12c1bd20-da56-4e72-8362-29ac2a66bace",
    "page_id": "12c1bd20-da56-4e72-8362-29ac2a66bace_p7",
    "element_id": "12c1bd20-da56-4e72-8362-29ac2a66bace_p7_tb-2-3",
    "origin_page": 7,
    "page": 7,
    "type": "figure",
    "bbox": [100, 200, 500, 650],
    "caption": "그림 3-1. 배선도",
    "ref_id": "fig-3-1"
  }
]
```
### 📌 pages.json
```json
[
  {
    "doc_id": "0003040d-0f71-4729-bd3b-733f3c8962bf",
    "page": 1,
    "slice_index": 0,
    "language":"ko",
    "source": "../ex_data/TEST-ALPHA01.pdf",
    "image": "../artifacts/TEST-ALPHA01_ko_p1_0.png",
    "modified_at": "2024-09-06T01:57:29Z"
  },
  {
    "doc_id": "0003040d-0f71-4729-bd3b-733f3c8962bf",
    "page": 2,
    "slice_index": 0,
    "language":"ko",
    "source": "../ex_data/TEST-ALPHA01.pdf",
    "image": "../artifacts/TEST-ALPHA01_ko_p2_0.png",
    "modified_at": "2024-09-06T01:57:29Z"
  },
  {
    "doc_id": "0003040d-0f71-4729-bd3b-733f3c8962bf",
    "page": 2,
    "slice_index": 1,
    "language":"ko",
    "source": "../ex_data/TEST-ALPHA01.pdf",
    "image": "../artifacts/TEST-ALPHA01_ko_p2_1.png",
    "modified_at": "2024-09-06T01:57:29Z"
  }
]
```